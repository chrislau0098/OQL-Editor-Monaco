# ONESQL 语法说明文档

## 概述

ONESQL 是一种用于 ONES 项目管理软件的查询语言，类似于 Jira 的 JQL。它通过字段（Field）、运算符（Operator）、值（Value）、关键字（Keyword）和函数（Function）等元素，帮助用户构建复杂的查询，以满足项目管理中的数据检索需求。

### 基本结构

- **查询结构**：`<字段> <运算符> <值>`
  - 示例：`project = Acme AND status != Closed`（查找项目为 Acme 且状态不为 Closed 的所有问题）
- **不区分大小写**：ONESQL 语言对大小写不敏感。
- **括号**：支持使用 `()` 组合多个子句，控制运算符优先级。
- **引号**：当值包含空格或特殊字符时，需用双引号 `""` 或单引号 `''` 括起来。
- **通配符**：支持 `*`（任意数量字符）和 `?`（单个字符）用于模糊搜索。
- **逻辑连接符**：支持 `AND` 和 `OR` 连接多个条件。

---

## 字段（Fields）

字段是 ONESQL 查询的核心，代表项目管理数据中的特定属性。每个字段具有对应的属性类型、支持的运算符、可取值范围和可选函数。

### 字段列表

| 字段名           | 属性类型         | 支持的运算符                                                 | 值（含动态值）                                               | 可选函数                                                     |
| ---------------- | ---------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 标题             | 单行文本         | `~`, `!~`, `IS`, `IS NOT`                                    | 文本, `empty`, `null`                                        | 无                                                           |
| 创建时间         | 时间             | `=`, `!=`, `>`, `>=`, `<`, `<=`, `IN`, `NOT IN`, `IS`, `IS NOT` | 1. 准确时间（"yyyy/MM/dd HH:mm", "yyyy-MM-dd HH:mm", "yyyy/MM/dd", "yyyy-MM-dd")<br>2. 相对时间（"+/-nn(w/d/h/m)"）<br>3. 时间类型属性<br>4. 日期类型属性 | `currentLogin()`, `lastLogin()`, `now()`, `startOfDay()`, `startOfWeek()`, `startOfMonth()`, `startOfSeason()`, `startOfYear()`, `endOfDay()`, `endOfWeek()`, `endOfMonth()`, `endOfSeason()`, `endOfYear()` |
| 创建者           | 单选成员         | `=`, `!=`, `IN`, `NOT IN`, `IS`, `IS NOT`                    | 1. 成员-用户名（含自己）<br>2. 成员-邮箱地址（含自己）<br>3. 单选成员属性<br>4. 多选成员类型属性 | `currentUser()`, `membersOf()`                               |
| 更新时间         | 时间             | `=`, `!=`, `>`, `>=`, `<`, `<=`, `IN`, `NOT IN`, `IS`, `IS NOT` | 同创建时间                                                   | 同创建时间                                                   |
| 工作项类型       | 工作项类型       | `=`, `!=`, `IN`, `NOT IN`, `IS`, `IS NOT`                    | 团队全部工作项类型（按名称升序）                             | `standardIssueTypes()`, `subIssueTypes()`                    |
| 子工作项类型     | 工作项类型       | `=`, `!=`, `IN`, `NOT IN`, `IS`, `IS NOT`                    | 团队全部子工作项类型（按名称升序）                           | 无                                                           |
| 所属项目         | 项目             | `=`, `!=`, `IN`, `NOT IN`, `IS`, `IS NOT`                    | 项目名称                                                     | 无                                                           |
| 处理结果         | 单选菜单         | `=`, `!=`, `IN`, `NOT IN`, `IS`, `IS NOT`                    | 处理结果选项值                                               | 无                                                           |
| 发布进度         | 浮点数           | `=`, `!=`, `>`, `>=`, `<`, `<=`, `IN`, `NOT IN`, `IS`, `IS NOT` | 1. 小于等于100的非负数<br>2. 其他浮点数类型属性<br>3. 其他整数类型属性 | 无                                                           |
| 发布日期         | 日期             | `=`, `!=`, `>`, `>=`, `<`, `<=`, `IN`, `NOT IN`, `IS`, `IS NOT` | 1. 日期（"yyyy/MM/dd", "yyyy-MM-dd"）<br>2. 相对时间（"+/-nn(w/d)"）<br>3. 时间类型属性<br>4. 日期类型属性 | 同创建时间                                                   |
| 负责人           | 单选成员         | `=`, `!=`, `IN`, `NOT IN`, `IS`, `IS NOT`                    | 同创建者                                                     | 同创建者                                                     |
| 故事点           | 浮点数           | `=`, `!=`, `IN`, `NOT IN`, `IS`, `IS NOT`                    | 选项值                                                       | 无                                                           |
| 关联发布         | 多选菜单         | `=`, `!=`, `IN`, `NOT IN`, `IS`, `IS NOT`                    | 发布标题、ID                                                 | `releasedVersions()`, `unreleasedVersions()`                 |
| 所属史诗         | 单选菜单         | `=`, `!=`, `IN`, `NOT IN`, `IS`, `IS NOT`                    | 史诗标题、ID                                                 | 无                                                           |
| ID               | 工作项编号       | `=`, `!=`, `IN`, `NOT IN`                                    | 正整数                                                       | 无                                                           |
| 截止日期         | 日期             | `=`, `!=`, `>`, `>=`, `<`, `<=`, `IN`, `NOT IN`, `IS`, `IS NOT` | 同发布日期                                                   | 同创建时间                                                   |
| 解决者           | 单选成员         | `=`, `!=`, `IN`, `NOT IN`, `IS`, `IS NOT`                    | 同创建者                                                     | 同创建者                                                     |
| 缺陷类型         | 单选菜单         | `=`, `!=`, `IN`, `NOT IN`, `IS`, `IS NOT`                    | 选项值                                                       | 无                                                           |
| 是否线上缺陷     | 单选菜单         | `=`, `!=`, `IN`, `NOT IN`, `IS`, `IS NOT`                    | "是"，"否"                                                   | 无                                                           |
| 所属产品         | 多选产品         | `=`, `!=`, `IN`, `NOT IN`, `IS`, `IS NOT`                    | 选项值                                                       | 无                                                           |
| 所属迭代         | 单选迭代         | `=`, `!=`, `IN`, `NOT IN`, `IS`, `IS NOT`                    | 迭代名称                                                     | `doneSprints()`, `todoSprints()`, `inprogressSprints()`      |
| 所属功能模块     | 多选功能模块     | `=`, `!=`, `IN`, `NOT IN`, `IS`, `IS NOT`                    | 选项值                                                       | 无                                                           |
| 严重程度         | 单选菜单         | `=`, `!=`, `IN`, `NOT IN`, `IS`, `IS NOT`                    | 选项值                                                       | 无                                                           |
| 优先级           | 单选菜单         | `=`, `!=`, `IN`, `NOT IN`, `IS`, `IS NOT`                    | 选项值                                                       | 无                                                           |
| 状态             | 工作项状态       | `=`, `!=`, `IN`, `NOT IN`                                    | 状态名                                                       | 无                                                           |
| 状态类型         | /                | `=`, `!=`, `IN`, `NOT IN`                                    | 状态类型名称                                                 | 无                                                           |
| 关注者           | 多选成员         | `=`, `!=`, `IN`, `NOT IN`, `IS`, `IS NOT`                    | 同创建者                                                     | 同创建者                                                     |
| 计划开始日期     | 日期             | `=`, `!=`, `>`, `>=`, `<`, `<=`, `IN`, `NOT IN`, `IS`, `IS NOT` | 同发布日期                                                   | 同创建时间                                                   |
| 计划完成日期     | 日期             | `=`, `!=`, `>`, `>=`, `<`, `<=`, `IN`, `NOT IN`, `IS`, `IS NOT` | 同发布日期                                                   | 同创建时间                                                   |
| 进度             | 浮点数           | `=`, `!=`, `>`, `>=`, `<`, `<=`, `IN`, `NOT IN`, `IS`, `IS NOT` | 同发布进度                                                   | 无                                                           |
| 总工时进度       | 浮点数           | `=`, `!=`, `>`, `>=`, `<`, `<=`, `IN`, `NOT IN`, `IS`, `IS NOT` | 同发布进度                                                   | 无                                                           |
| 工时进度         | 浮点数           | `=`, `!=`, `>`, `>=`, `<`, `<=`, `IN`, `NOT IN`, `IS`, `IS NOT` | 同发布进度                                                   | 无                                                           |
| 停留次数类       | 属性选项停留次数 | `=`, `!=`, `>`, `>=`, `<`, `<=`, `IN`, `NOT IN`, `IS`, `IS NOT` | 1. 整数<br>2. 其他浮点数类型属性<br>3. 其他整数类型属性      | 无                                                           |
| 停留时间类       | 属性选项停留时间 | `=`, `!=`, `>`, `>=`, `<`, `<=`, `IN`, `NOT IN`, `IS`, `IS NOT` | 1. 时间长度（"d/h/m"）<br>2. 其他属性选项停留时间类型属性    | 无                                                           |
| 总剩余工时       | 浮点数           | `=`, `!=`, `>`, `>=`, `<`, `<=`, `IN`, `NOT IN`, `IS`, `IS NOT` | 1. 浮点数<br>2. 其他浮点数类型属性<br>3. 其他整数类型属性    | 无                                                           |
| 总已登记工时     | 浮点数           | `=`, `!=`, `>`, `>=`, `<`, `<=`, `IN`, `NOT IN`, `IS`, `IS NOT` | 同总剩余工时                                                 | 无                                                           |
| 总预估工时       | 浮点数           | `=`, `!=`, `>`, `>=`, `<`, `<=`, `IN`, `NOT IN`, `IS`, `IS NOT` | 同总剩余工时                                                 | 无                                                           |
| 总预估偏差       | 浮点数           | `=`, `!=`, `>`, `>=`, `<`, `<=`, `IN`, `NOT IN`, `IS`, `IS NOT` | 同总剩余工时                                                 | 无                                                           |
| 单选菜单         | 单选菜单         | `=`, `!=`, `IN`, `NOT IN`, `IS`, `IS NOT`                    | 选项值                                                       | 无                                                           |
| 多选菜单         | 多选菜单         | `=`, `!=`, `IN`, `NOT IN`, `IS`, `IS NOT`                    | 选项值                                                       | 无                                                           |
| 单行文本         | 单行文本         | `~`, `!~`, `IS`, `IS NOT`                                    | 文本, `empty`, `null`                                        | 无                                                           |
| 多行文本         | 多行文本         | `~`, `!~`, `IS`, `IS NOT`                                    | 文本, `empty`, `null`                                        | 无                                                           |
| 富文本           | 富文本           | `~`, `!~`, `IS`, `IS NOT`                                    | 文本, `empty`, `null`                                        | 无                                                           |
| 日期             | 日期             | `=`, `!=`, `>`, `>=`, `<`, `<=`, `IN`, `NOT IN`, `IS`, `IS NOT` | 同发布日期                                                   | 同创建时间                                                   |
| 时间             | 时间             | `=`, `!=`, `>`, `>=`, `<`, `<=`, `IN`, `NOT IN`, `IS`, `IS NOT` | 同创建时间                                                   | 同创建时间                                                   |
| 单选迭代         | 单选迭代         | `=`, `!=`, `IN`, `NOT IN`, `IS`, `IS NOT`                    | 迭代名称                                                     | `doneSprints()`, `todoSprints()`, `inprogressSprints()`      |
| 单选成员         | 单选成员         | `=`, `!=`, `IN`, `NOT IN`, `IS`, `IS NOT`                    | 同创建者                                                     | 同创建者                                                     |
| 多选成员         | 多选成员         | `=`, `!=`, `IN`, `NOT IN`, `IS`, `IS NOT`                    | 同创建者                                                     | 同创建者                                                     |
| 多选项目         | 多选项目         | `=`, `!=`, `IN`, `NOT IN`, `IS`, `IS NOT`                    | 项目名称                                                     | 无                                                           |
| 整数             | 整数             | `=`, `!=`, `>`, `>=`, `<`, `<=`, `IN`, `NOT IN`, `IS`, `IS NOT` | 1. 整数<br>2. 其他浮点数类型属性<br>3. 其他整数类型属性      | 无                                                           |
| 浮点数           | 浮点数           | `=`, `!=`, `>`, `>=`, `<`, `<=`, `IN`, `NOT IN`, `IS`, `IS NOT` | 1. 浮点数<br>2. 其他浮点数类型属性<br>3. 其他整数类型属性    | 无                                                           |
| 间隔时间         | 间隔时间         | `=`, `!=`, `>`, `>=`, `<`, `<=`, `IN`, `NOT IN`, `IS`, `IS NOT` | 1. 时间长度（"d/h/m"，支持正负）<br>2. 其他间隔时间类型属性  | 无                                                           |
| 属性选项停留次数 | 属性选项停留次数 | `=`, `!=`, `>`, `>=`, `<`, `<=`, `IN`, `NOT IN`, `IS`, `IS NOT` | 同停留次数类                                                 | 无                                                           |
| 属性选项停留时间 | 属性选项停留时间 | `=`, `!=`, `>`, `>=`, `<`, `<=`, `IN`, `NOT IN`, `IS`, `IS NOT` | 同停留时间类                                                 | 无                                                           |
| 出现时间         | 出现时间         | `=`, `!=`, `>`, `>=`, `<`, `<=`, `IN`, `NOT IN`, `IS`, `IS NOT` | 同创建时间                                                   | 同创建时间                                                   |
| 多选部门         | 多选部门         | `=`, `!=`, `IN`, `NOT IN`, `IS`, `IS NOT`                    | 部门选项值                                                   | 无                                                           |
| 工作项           | 特殊字段         | `IN`, `NOT IN`                                               | 无                                                           | `issueHistory()`                                             |

---

## 运算符（Operators）

运算符定义字段与值之间的关系，不同属性类型支持的运算符有所不同。

### 运算符列表

| 运算符   | 说明                                          | 支持的属性类型                                               | 示例                               |
| -------- | --------------------------------------------- | ------------------------------------------------------------ | ---------------------------------- |
| `=`      | 字段值与指定值完全匹配                        | 除文本类型外，所有类型                                       | `负责人 = "张三"`                  |
| `!=`     | 字段值与指定值不匹配                          | 除文本类型外，所有类型                                       | `负责人 != "张三"`                 |
| `>`      | 字段值大于指定值                              | 日期、时间、整数、浮点数、停留次数、停留时间、间隔时间、出现时间 | `截止日期 > "2008/12/31"`          |
| `>=`     | 字段值大于或等于指定值                        | 日期、时间、整数、浮点数、停留次数、停留时间、间隔时间、出现时间 | `截止日期 >= "2008/12/31"`         |
| `<`      | 字段值小于指定值                              | 日期、时间、整数、浮点数、停留次数、停留时间、间隔时间、出现时间 | `截止日期 < "2008/12/31"`          |
| `<=`     | 字段值小于或等于指定值                        | 日期、时间、整数、浮点数、停留次数、停留时间、间隔时间、出现时间 | `截止日期 <= "2008/12/31"`         |
| `IN`     | 字段值在指定值列表中                          | 多种类型                                                     | `状态 IN ("进行中", "已完成")`     |
| `NOT IN` | 字段值不在指定值列表中                        | 多种类型                                                     | `状态 NOT IN ("进行中", "已完成")` |
| `~`      | 字段值包含指定文本（模糊匹配）                | 文本类型（单行文本、多行文本、富文本）                       | `标题 ~ "文本"`                    |
| `!~`     | 字段值不包含指定文本（模糊匹配）              | 文本类型（单行文本、多行文本、富文本）                       | `标题 !~ "文本"`                   |
| `IS`     | 字段值为空（与 `empty` 或 `null` 配合使用）   | 多种类型                                                     | `截止日期 IS empty`                |
| `IS NOT` | 字段值不为空（与 `empty` 或 `null` 配合使用） | 多种类型                                                     | `截止日期 IS NOT empty`            |

### 备注

- **`!=` 的行为**：不会匹配值为空的字段，需使用 `IS empty` 查找空值。
- **等价关系**：
  - `field != value` 等价于 `NOT field = value`
  - `field != EMPTY` 等价于 `field IS NOT EMPTY`

---

## 函数（Functions）

函数用于在查询中执行特定操作或返回动态值，支持多种业务场景。

### 函数列表

| 函数名                 | 业务场景                       | 语法                                     | 输出                | 支持的字段类型                                     | 支持的运算符                    | 示例                                             |
| ---------------------- | ------------------------------ | ---------------------------------------- | ------------------- | -------------------------------------------------- | ------------------------------- | ------------------------------------------------ |
| `membersOf()`          | 根据特定群组的成员搜索         | `membersOf(Group)`                       | 群组成员集合        | 单选成员、多选成员、负责人、创建者、解决者、关注者 | `IN`, `NOT IN`                  | `负责人 NOT IN membersOf(测试)`                  |
| `currentUser()`        | 根据当前登录用户搜索           | `currentUser()`                          | 当前用户            | 单选成员、多选成员、负责人、创建者、解决者、关注者 | `=`, `!=`                       | `负责人 = currentUser()`                         |
| `currentLogin()`       | 根据当前会话开始时间搜索       | `currentLogin()`                         | 当前会话开始时间    | 时间、日期类型                                     | `=`, `!=`, `>`, `>=`, `<`, `<=` | `创建日期 > currentLogin()`                      |
| `lastLogin()`          | 根据上一次会话开始时间搜索     | `lastLogin()`                            | 上一次会话开始时间  | 时间、日期类型                                     | `=`, `!=`, `>`, `>=`, `<`, `<=` | `创建日期 > lastLogin()`                         |
| `now()`                | 根据当前时间点搜索             | `now()`                                  | 当前时间点          | 时间、日期类型                                     | `=`, `!=`, `>`, `>=`, `<`, `<=` | `截止日期 < now()`                               |
| `startOfDay()`         | 根据当天开始时间的相对值搜索   | `startOfDay("inc")`                      | 指定时间点          | 时间、日期类型                                     | `=`, `!=`, `>`, `>=`, `<`, `<=` | `创建日期 > startOfDay("-3d")`                   |
| `startOfWeek()`        | 根据本周开始时间的相对值搜索   | `startOfWeek("inc")`                     | 指定时间点          | 时间、日期类型                                     | `=`, `!=`, `>`, `>=`, `<`, `<=` | `创建日期 > startOfWeek("-1")`                   |
| `startOfMonth()`       | 根据本月开始时间的相对值搜索   | `startOfMonth("inc")`                    | 指定时间点          | 时间、日期类型                                     | `=`, `!=`, `>`, `>=`, `<`, `<=` | `创建日期 > startOfMonth("-1")`                  |
| `startOfSeason()`      | 根据本季度开始时间的相对值搜索 | `startOfSeason("inc")`                   | 指定时间点          | 时间、日期类型                                     | `=`, `!=`, `>`, `>=`, `<`, `<=` | `创建日期 > startOfSeason("-1")`                 |
| `startOfYear()`        | 根据本年开始时间的相对值搜索   | `startOfYear("inc")`                     | 指定时间点          | 时间、日期类型                                     | `=`, `!=`, `>`, `>=`, `<`, `<=` | `创建日期 > startOfYear("-1")`                   |
| `endOfDay()`           | 根据当天结束时间的相对值搜索   | `endOfDay("inc")`                        | 指定时间点          | 时间、日期类型                                     | `=`, `!=`, `>`, `>=`, `<`, `<=` | `截止日期 < endOfDay("+1")`                      |
| `endOfWeek()`          | 根据本周结束时间的相对值搜索   | `endOfWeek("inc")`                       | 指定时间点          | 时间、日期类型                                     | `=`, `!=`, `>`, `>=`, `<`, `<=` | `截止日期 < endOfWeek("+1")`                     |
| `endOfMonth()`         | 根据本月结束时间的相对值搜索   | `endOfMonth("inc")`                      | 指定时间点          | 时间、日期类型                                     | `=`, `!=`, `>`, `>=`, `<`, `<=` | `截止日期 < endOfMonth("+15d")`                  |
| `endOfSeason()`        | 根据本季度结束时间的相对值搜索 | `endOfSeason("inc")`                     | 指定时间点          | 时间、日期类型                                     | `=`, `!=`, `>`, `>=`, `<`, `<=` | `截止日期 < endOfSeason("+1")`                   |
| `endOfYear()`          | 根据本年结束时间的相对值搜索   | `endOfYear("inc")`                       | 指定时间点          | 时间、日期类型                                     | `=`, `!=`, `>`, `>=`, `<`, `<=` | `截止日期 < endOfYear("+3M")`                    |
| `releasedVersions()`   | 根据已发布版本搜索             | `releasedVersions("project", "title")`   | 符合条件的发布列表  | 关联发布                                           | `IN`, `NOT IN`                  | `关联发布 IN releasedVersions("路线图", "V6")`   |
| `unreleasedVersions()` | 根据未发布版本搜索             | `unreleasedVersions("project", "title")` | 符合条件的发布列表  | 关联发布                                           | `IN`, `NOT IN`                  | `关联发布 IN unreleasedVersions("路线图", "V6")` |
| `inprogressSprints()`  | 搜索进行中的迭代               | `inprogressSprints()`                    | 符合条件的迭代列表  | 所属迭代                                           | `IN`, `NOT IN`                  | `所属迭代 IN inprogressSprints()`                |
| `doneSprints()`        | 搜索已完成的迭代               | `doneSprints()`                          | 符合条件的迭代列表  | 所属迭代                                           | `IN`, `NOT IN`                  | `所属迭代 IN doneSprints()`                      |
| `todoSprints()`        | 搜索未开始的迭代               | `todoSprints()`                          | 符合条件的迭代列表  | 所属迭代                                           | `IN`, `NOT IN`                  | `所属迭代 IN todoSprints()`                      |
| `issueHistory()`       | 搜索最近查看的工作项           | `issueHistory(n)`                        | 最近 n 个工作项列表 | 工作项                                             | `IN`, `NOT IN`                  | `工作项 IN issueHistory(10)`                     |
| `standardIssueTypes()` | 搜索标准工作项类型             | `standardIssueTypes()`                   | 标准工作项类型列表  | 工作项类型                                         | `IN`, `NOT IN`                  | `工作项类型 IN standardIssueTypes()`             |
| `subIssueTypes()`      | 搜索子工作项类型               | `subIssueTypes()`                        | 子工作项类型列表    | 工作项类型                                         | `IN`, `NOT IN`                  | `工作项类型 IN subIssueTypes()`                  |

#### 时间函数参数说明
- 时间函数（如 `startOfDay()`、`endOfWeek()` 等）支持可选参数 `inc`，格式为 `(+/-)nn(y|M|w|d|h|m)`：
  - `y`（年）、`M`（月）、`w`（周）、`d`（天）、`h`（小时）、`m`（分钟）
  - 示例：`startOfDay("+3d")` 表示 3 天后的当天开始时间
  - 未指定正负时，默认正；未指定单位时，默认按函数类型（如 `startOfWeek` 默认周）。

---

## 语法规则

- **基本结构**：`<字段> <运算符> <值>`，多个条件通过 `AND` 或 `OR` 连接。
- **括号**：用 `()` 控制运算符优先级。
- **引号**：值含空格或特殊字符时，用 `""` 或 `''` 括起来。
- **通配符**：`*`（任意字符）、`?`（单字符），用于模糊搜索。
- **不区分大小写**：字段名、运算符、值等均不区分大小写。

### 示例查询

- **基本查询**：`project = Acme AND status != Closed`
- **模糊搜索**：`标题 ~ "文本*"`
- **空值查询**：`截止日期 IS NOT empty`
- **函数查询**：`负责人 = currentUser()`
- **复杂查询**：`创建日期 > startOfWeek("-1") AND 状态 IN ("进行中", "已完成")

